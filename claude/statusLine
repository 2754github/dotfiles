#!/bin/bash
set -eu

echo "🕒$(date '+%Y-%m-%d %H:%M:%S (%Z)')"

# https://app.link.com/purchases
if [[ $(date +%-d) -lt 6 ]]; then
  since=$(date -v-1m +%Y%m06)
  until=$(date +%Y%m06)
else
  since=$(date +%Y%m06)
  until=$(date -v+1m +%Y%m06)
fi
ccusage -j -s $since -u $until | jq -r '"💰\(.totals.totalCost * 100 | round / 100) (USD)"'

# OUTDATED --------------------------------------------------------------------
echo '⚠️ OUTDATED'

npm_outdated=$(npm outdated -g --json | jq -r 'keys | join(", ")')
if [[ -n $npm_outdated ]]; then
  echo "├─📦npm:      $npm_outdated"
fi

brew_formulae_outdated=$(
  brew info --installed --json=v2 | jq -r '
    .formulae
    | map(select((.outdated) and (.installed | any(.installed_on_request))) | .name)
    | join(", ")
  '
)
if [[ -n $brew_formulae_outdated ]]; then
  echo "├─🍺formulae: $brew_formulae_outdated"
fi

brew_casks_outdated=$(
  brew outdated --casks -g --json=v2 | jq -r '.casks | map(.name) | join(", ")'
)
if [[ -n $brew_casks_outdated ]]; then
  echo "├─🍺casks:    $brew_casks_outdated"
fi
